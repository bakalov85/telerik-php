<?phpmb_internal_encoding('UTF-8');include 'includes/constants.php';$date = date('d-m-Y');$error = false;$dateFormatError = false;$action = preg_replace('/[^a-z]/', '', $_GET['action']);$selectedGroup = (int) $_GET['group'];if ($action == 'edit') {      $pageTitle = 'Редакция на разход';      $buttonText = 'Запиши промените';      $editFatalError = false;      $rowToEditNumb = (int) $_GET['rowNumb'];      if (file_exists('data.txt')) {            $result = file('data.txt');            if (count($result) < $rowToEditNumb) {                  $messageErrors[] = 3;                  $editFatalError = true;            }            $rowToEdit = $result[$rowToEditNumb];            if ($rowToEdit) {                  $rowParts = explode('|', $rowToEdit);                  if (count($rowParts) == 5) {                        $rowUniqueIndex = $rowParts[0];                        $date = date('d-m-Y', $rowParts[1]);                        $name = $rowParts[2];                        $selectedGroup = $rowParts[3];                        $cost = $rowParts[4];                  }                   else {                        $messageErrors[] = 1;                        $editFatalError = true;                  }            }             else {                  $messageErrors[] = 2;                  $editFatalError = true;            }      }       else {            $messageErrors[] = 4;            $editFatalError = true;      }            } else if ($action == 'delete') {      $rowToDelete = (int) $_GET['rowNumb'];      if (file_exists('data.txt')) {            $result = file('data.txt');            $fileContentStr = implode('', $result);            if (count($result) < $rowToDelete) {                  $messageErrors[] = 5;                  $deleteFatalError = true;            }            $replaceThis = $result[$rowToDelete];            $replaceWithThat = '';            $fileContent = str_replace($replaceThis, $replaceWithThat, $fileContentStr);            if (file_put_contents('data.txt', $fileContent)) {                  header('Location:index.php?message=15');            }             else {                  $messageErrors[] = 6;            }      }}if ($_POST) {      $name = trim($_POST['name']);      $name = filter_var($name, FILTER_SANITIZE_STRING);      $name = str_replace('|', '', $name);      $cost = trim($_POST['cost']);      $cost = (float) str_replace(array('|', ','), array('', '.'), $cost);      $selectedGroup = (int) $_POST['group'];      $date = preg_replace('/[^0-9-]/', '', $_POST['date']);      /* Малко проверки на датата ... */      if (!$date) {            $messageErrors[] = 11;            $error = true;      }       else if (strlen($date) != 10) {            $dateFormatError = true;      }       else {            $dateExpl = explode('-', $date);            if (count($dateExpl) != 3) {                  $dateFormatError = true;            } elseif (!checkdate((int) $dateExpl[1], (int) $dateExpl[0], (int) $dateExpl[2])) {                  $dateFormatError = true;            }      }      if ($dateFormatError) {            $messageErrors[] = 12;            $error = true;      }      if (mb_strlen($name) <= 3) {            $messageErrors[] = 7;            $error = true;      }      if ($cost <= 0) {            $messageErrors[] = 8;            $error = true;      }       elseif (is_float($cost)) {            $costParts = explode('.', $cost);            if (strlen($costParts[1]) > 2) {                  $messageErrors[] = 9;            }      }      $unixTimestamp = strtotime("$date 00:00:01");                  if (!array_key_exists($selectedGroup, $groups) || $selectedGroup == 0) {            $messageErrors[] = 10;            $error = true;      }      if (!$error) {            if (file_exists('data.txt')) {                  $result = file('data.txt');                  $fileContentStr = implode('', $result);                  $countRows = count($result);                  if ($countRows > 0) {                        $lastRow = $result[$countRows - 1];                        $lastRowArray = explode('|', $lastRow);                        $nextId = $lastRowArray[0] + 1;                  }                   else {                        $nextId = 1;                  }            }             else {                  $nextId = 1;            }                        if ($action == 'edit') {                  if (!$editFatalError) {                        $replaceThis = $rowToEdit;                        $replaceWithThat = $rowUniqueIndex . '|' . $unixTimestamp . '|' . $name . '|' . $selectedGroup . '|' . $cost . "\r\n";                        $fileContent = str_replace($replaceThis, $replaceWithThat, $fileContentStr);                  }                   else {                        $messageErrors[] = 13;                        //Maybe redirect home with error message                         //header('Location:index.php?message=1');                  }            }             else {                  $addToContent = $nextId . '|' . $unixTimestamp . '|' . $name . '|' . $selectedGroup . '|' . $cost . "\r\n";                  $fileContent .= $fileContentStr . '' . $addToContent;            }            if (file_put_contents('data.txt', $fileContent)) {                  $messageErrors[] = 14;                  if ($action != 'edit') {                        unset($name, $cost, $selectedGroup);                  }            }             else {                  $messageErrors[] = 6;            }      }}if (!$pageTitle) {      $pageTitle = 'Добавяне на нов разход';}if (!$buttonText) {      $buttonText = 'Добави';}include 'includes/header.php';?>                   <div class="menu">      <a href ="index.php">Списък с всички разходи</a>      <a href="form.php" class="current">Добави разход</a> </div><?phpinclude 'includes/messages.php';?><div id="container">      <form method="POST" action="">            <table class='noBorders'>                  <tr>                        <td>Дата:</td>                        <td><input type="text" name="date" value="<?php echo $date; ?>" id="selectDate" /></td>                  </tr>                  <tr>                        <td>Наименование:</td>                        <td><input type="text" name="name" value="<?php echo $name; ?>"/></td>                  </tr>                  <tr>                        <td>Сума:</td>                        <td><input type="text" name="cost"  value="<?php echo $cost; ?>"/></td>                  </tr>                  <tr>                        <td>Вид:</td>                        <td>                              <select name="group">                                    <?php echo generateOptionSelect($groups, $selectedGroup, 0); ?>                              </select>                        </td>                  </tr>                  <tr>                        <td colspan="2" class="tac">                              <input type="submit" value="<?php echo $buttonText; ?>" />                        </td>                  </tr>            </table>      </form><?phpinclude 'includes/footer.php';?> 